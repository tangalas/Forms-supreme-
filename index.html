<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vehicle Rental Form</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    :root {
      --emerald-100: #d1fae5;
      --emerald-400: #34d399;
      --emerald-600: #059669;
      --emerald-700: #047857;
      --purple-900: #4c1d95;
      --indigo-700: #4338ca;
      --indigo-800: #3730a3;
      --gray-100: #f3f4f6;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-700: #374151;
      --red-500: #ef4444;
      --blue-500: #3b82f6;
      --white: #ffffff;
      --black: #000000;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      line-height: 1.5;
      background-color: var(--emerald-400);
      color: var(--gray-700);
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 1rem;
    }

    .rental-form {
      background-color: var(--emerald-400);
      padding: 1.5rem;
      border-radius: 0.5rem;
    }

    .form-section {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
    }

    .required {
      color: var(--red-500);
    }

    input[type="text"],
    input[type="date"],
    input[type="time"],
    input[type="email"],
    input[type="tel"],
    textarea,
    select {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--gray-300);
      border-radius: 0.25rem;
      background-color: var(--white);
      font-size: 1rem;
    }

    .phone-input {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 0.5rem;
    }

    .input-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      margin-top: 0.25rem;
    }

    .checkbox-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.5rem;
    }

    @media (min-width: 768px) {
      .checkbox-grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    .checkbox-item, .radio-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .date-time-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }

    @media (min-width: 768px) {
      .date-time-grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    .input-label {
      font-size: 0.75rem;
      margin-top: 0.25rem;
    }

    .file-upload {
      border: 1px solid var(--gray-300);
      border-radius: 0.25rem;
      padding: 1.5rem;
      background-color: var(--white);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      cursor: pointer;
    }

    .upload-icon {
      width: 3rem;
      height: 3rem;
      border-radius: 50%;
      border: 2px solid var(--gray-300);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 0.5rem;
      color: var(--gray-400);
    }

    .upload-text {
      font-size: 1rem;
      color: var(--gray-500);
      font-weight: 500;
    }

    .upload-subtext {
      font-size: 0.875rem;
      color: var(--gray-400);
    }

    .file-input {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
    }

    .divider {
      border: none;
      border-top: 1px solid var(--gray-300);
      margin: 1.5rem 0;
    }

    .section-title {
      font-size: 1.25rem;
      font-weight: 500;
      margin-bottom: 1rem;
    }

    .accessory-group {
      margin-bottom: 1.5rem;
    }

    .number-buttons {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .number-button {
      width: 3rem;
      height: 3rem;
      border-radius: 50%;
      border: 1px solid var(--gray-300);
      background-color: var(--white);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      cursor: pointer;
    }

    .number-button.active {
      background-color: var(--emerald-600);
      color: var(--white);
      border-color: var(--emerald-600);
    }

    .terms-header {
      text-align: center;
      margin-bottom: 1rem;
    }

    .terms-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--purple-900);
    }

    .terms-card {
      background-color: var(--emerald-100);
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .terms-subtitle {
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .terms-text {
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
    }

    .terms-checkbox {
      margin-top: 1rem;
    }

    .terms-link {
      color: var(--blue-500);
      text-decoration: underline;
    }

    .radio-group {
      display: flex;
      gap: 1rem;
      margin-top: 0.5rem;
    }

    .signature-pad-container {
      position: relative;
      border: 1px solid var(--gray-300);
      border-radius: 0.5rem;
      background-color: var(--white);
      height: 150px;
      margin-top: 0.5rem;
    }

    .signature-pad {
      width: 100%;
      height: 100%;
      border-radius: 0.5rem;
    }

    .clear-button {
      position: absolute;
      bottom: 0.5rem;
      right: 0.5rem;
      padding: 0.25rem 0.5rem;
      background-color: var(--white);
      border: 1px solid var(--gray-300);
      border-radius: 0.25rem;
      font-size: 0.875rem;
      cursor: pointer;
    }

    .submit-container {
      display: flex;
      justify-content: flex-end;
      margin-top: 1.5rem;
    }

    .submit-button {
      background-color: var(--indigo-700);
      color: var(--white);
      border: none;
      border-radius: 0.25rem;
      padding: 0.5rem 2rem;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .submit-button:hover {
      background-color: var(--indigo-800);
    }

    .submit-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Toast notification */
    .toast {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      background-color: var(--white);
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 1rem;
      display: flex;
      align-items: flex-start;
      max-width: 350px;
      z-index: 1000;
      transform: translateY(150%);
      transition: transform 0.3s ease-in-out;
    }

    .toast.show {
      transform: translateY(0);
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .toast-message {
      font-size: 0.875rem;
      color: var(--gray-500);
    }

    .toast-close {
      background: none;
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
      color: var(--gray-500);
      margin-left: 0.5rem;
    }

    .toast.success {
      border-left: 4px solid var(--emerald-600);
    }

    .toast.error {
      border-left: 4px solid var(--red-500);
    }
  </style>
</head>
<body>
  <main class="container">
    <form id="vehicleRentalForm" class="rental-form">
      <div class="form-section">
        <!-- Phone Number -->
        <div class="form-group">
          <label for="phoneCountry">Phone Number</label>
          <div class="phone-input">
            <input type="text" id="phoneCountry" placeholder="+1" class="country-code">
            <input type="text" id="phoneNumber" placeholder="Phone Number" class="phone-number">
          </div>
          <div class="input-labels">
            <span>Country Code</span>
            <span>Phone Number</span>
          </div>
        </div>

        <!-- Vehicle Type -->
        <div class="form-group">
          <label class="form-label">
            Type of Vehicle <span class="required">*</span>
          </label>
          <div class="checkbox-grid">
            <div class="checkbox-item">
              <input type="checkbox" id="escooter">
              <label for="escooter">E-Scooter</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="mountainEbike">
              <label for="mountainEbike">Mountain E-Bike</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="trekkingEbike">
              <label for="trekkingEbike">Trekking E-bike</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="fatTireEbike">
              <label for="fatTireEbike">Fat Tire E-bike</label>
            </div>
          </div>
        </div>

        <!-- ID Upload -->
        <div class="form-group">
          <label class="form-label">
            Passport/ ID / DRIVER'S LICENSE <span class="required">*</span>
          </label>
          <div class="file-upload" id="idUpload">
            <div class="upload-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
              </svg>
            </div>
            <div class="upload-text">Browse Files</div>
            <div class="upload-subtext">Drag and drop files here</div>
            <input type="file" id="idFile" class="file-input" accept="image/*,.pdf">
          </div>
        </div>

        <hr class="divider">

        <!-- Rental Period -->
        <div class="date-time-grid">
          <div class="form-group">
            <label class="form-label">
              From <span class="required">*</span>
            </label>
            <input type="date" id="fromDate" class="date-input">
            <div class="input-label">Date</div>
          </div>

          <div class="form-group">
            <label class="form-label">
              Time <span class="required">*</span>
            </label>
            <input type="time" id="fromTime" class="time-input">
            <div class="input-label">Hour Minutes</div>
          </div>

          <div class="form-group">
            <label class="form-label">Until</label>
            <input type="date" id="untilDate" class="date-input">
            <div class="input-label">Date</div>
          </div>

          <div class="form-group">
            <label class="form-label">Time</label>
            <input type="time" id="untilTime" class="time-input">
            <div class="input-label">Hour Minutes</div>
          </div>
        </div>

        <!-- Vehicle Condition -->
        <div class="form-group">
          <label class="form-label">
            Vehicle Condition Before Rental <span class="required">*</span>
          </label>
          <div class="file-upload" id="conditionUpload">
            <div class="upload-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
              </svg>
            </div>
            <div class="upload-text">Browse Files</div>
            <div class="upload-subtext">Drag and drop multiple images here</div>
            <input type="file" id="conditionFiles" class="file-input" accept="image/*" multiple>
          </div>
        </div>

        <!-- Accessories -->
        <div class="form-group">
          <h2 class="section-title">Accessories</h2>
          <hr class="divider">

          <!-- Helmet -->
          <div class="accessory-group">
            <label class="form-label">Helmet</label>
            <div class="number-buttons">
              <button type="button" class="number-button active" data-value="0" data-type="helmet">0</button>
              <button type="button" class="number-button" data-value="1" data-type="helmet">1</button>
              <button type="button" class="number-button" data-value="2" data-type="helmet">2</button>
              <button type="button" class="number-button" data-value="3" data-type="helmet">3</button>
              <button type="button" class="number-button" data-value="4" data-type="helmet">4</button>
              <button type="button" class="number-button" data-value="5" data-type="helmet">5</button>
            </div>
            <input type="hidden" id="helmetCount" value="0">
          </div>

          <!-- Lock -->
          <div class="accessory-group">
            <label class="form-label">Lock</label>
            <div class="number-buttons">
              <button type="button" class="number-button active" data-value="0" data-type="lock">0</button>
              <button type="button" class="number-button" data-value="1" data-type="lock">1</button>
              <button type="button" class="number-button" data-value="2" data-type="lock">2</button>
              <button type="button" class="number-button" data-value="3" data-type="lock">3</button>
              <button type="button" class="number-button" data-value="4" data-type="lock">4</button>
              <button type="button" class="number-button" data-value="5" data-type="lock">5</button>
            </div>
            <input type="hidden" id="lockCount" value="0">
          </div>

          <!-- Elastic Straps -->
          <div class="accessory-group">
            <label class="form-label">Elastic Straps</label>
            <div class="number-buttons">
              <button type="button" class="number-button active" data-value="0" data-type="straps">0</button>
              <button type="button" class="number-button" data-value="1" data-type="straps">1</button>
              <button type="button" class="number-button" data-value="2" data-type="straps">2</button>
              <button type="button" class="number-button" data-value="3" data-type="straps">3</button>
              <button type="button" class="number-button" data-value="4" data-type="straps">4</button>
              <button type="button" class="number-button" data-value="5" data-type="straps">5</button>
            </div>
            <input type="hidden" id="strapsCount" value="0">
          </div>

          <!-- Other Accessories -->
          <div class="accessory-group">
            <label class="form-label">Other Accessories</label>
            <div class="checkbox-grid">
              <div class="checkbox-item">
                <input type="checkbox" id="bikeMirror">
                <label for="bikeMirror">Bike Mirror</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="phoneMount">
                <label for="phoneMount">Phone Mount</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="charger">
                <label for="charger">Charger</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="batteryKey">
                <label for="batteryKey">Battery Key</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="babySeat">
                <label for="babySeat">Baby Seat</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="bikeBasket">
                <label for="bikeBasket">Bike Basket</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="seatCushion">
                <label for="seatCushion">Seat Cushion</label>
              </div>
            </div>
          </div>
        </div>

        <hr class="divider">

        <!-- Terms and Conditions -->
        <div class="form-group">
          <div class="terms-header">
            <h2 class="terms-title">TERMS AND CONDITIONS OF VEHICLE RENTAL</h2>
          </div>

          <div class="terms-card">
            <h3 class="terms-subtitle">TERMS AND CONDITIONS OF VEHICLE RENTAL</h3>
            <p class="terms-text">- Only the persons mentioned in the agreement will be allowed to drive the vehicle. In case any vehicle is to be used by an underage person, specifically (15-17) years old for the e-bikes or (12-17) for the scooters, then this contract is the written consent of the parent. More on the respective section below.*</p>
            <p class="terms-text">-The renter is responsible for any violation of traffic rules: wrong parking, fast driving etc.</p>
            <p class="terms-text">- It is strictly forbidden to ride a bike/scooter off-road, to ride any bike/scooter on the beach and to ride any bike/scooter with more than one person, the renter will return at the same time to the equipment and accessories. the city where the vehicle was rented or as otherwise specified on the signed page of the contract. Extension of the rental period is done with the approval of the owner and without it the renter will be charged accordingly.</p>
            <p class="terms-text">- The renter is obliged to return the vehicle's batteries fully charged, if the rental period is at least 24 hours.</p>
          </div>

          <div class="checkbox-item terms-checkbox">
            <input type="checkbox" id="termsAgreed">
            <label for="termsAgreed">
              I have read and agreed to the 
              <a href="#" class="terms-link">terms & conditions</a>
              <span class="required">*</span>
            </label>
          </div>
        </div>

        <!-- Underage Participant -->
        <div class="form-group">
          <label class="form-label">Is there any underaged person participating?</label>
          <div class="radio-group">
            <div class="radio-item">
              <input type="radio" id="yes" name="isUnderage" value="yes">
              <label for="yes">Yes</label>
            </div>
            <div class="radio-item">
              <input type="radio" id="no" name="isUnderage" value="no">
              <label for="no">No</label>
            </div>
          </div>
        </div>

        <!-- Owner's Signature -->
        <div class="form-group">
          <label class="form-label">Owner's signature:</label>
          <div class="signature-pad-container">
            <canvas id="ownerSignature" class="signature-pad"></canvas>
          </div>
        </div>

        <!-- Participant's Signature -->
        <div class="form-group">
          <label class="form-label">
            Participant's signature <span class="required">*</span>
          </label>
          <div class="signature-pad-container">
            <canvas id="participantSignature" class="signature-pad"></canvas>
            <button type="button" id="clearParticipantSignature" class="clear-button">Clear</button>
          </div>
        </div>

        <!-- Submit Button -->
        <div class="submit-container">
          <button type="submit" id="submitButton" class="submit-button">Submit</button>
        </div>
      </div>
    </form>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
      <div class="toast-content">
        <div id="toastTitle" class="toast-title"></div>
        <div id="toastMessage" class="toast-message"></div>
      </div>
      <button id="toastClose" class="toast-close">×</button>
    </div>
  </main>

  <!-- Include necessary libraries -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>
  <script src="https://cdn.jsdelivr.net/npm/jwt-encode@1.0.1/build/jwt-encode.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Google Drive credentials
      const GOOGLE_SERVICE_ACCOUNT_EMAIL = "YOUR_SERVICE_ACCOUNT_EMAIL"; // Replace with your service account email
      const GOOGLE_PRIVATE_KEY = "YOUR_PRIVATE_KEY"; // Replace with your private key
      const GOOGLE_DRIVE_FOLDER_ID = "YOUR_FOLDER_ID"; // Replace with your folder ID

      // Initialize signature pads
      const ownerCanvas = document.getElementById('ownerSignature');
      const participantCanvas = document.getElementById('participantSignature');
      
      const ownerSignaturePad = new SignaturePad(ownerCanvas, {
        backgroundColor: 'rgba(255, 255, 255, 0)',
        penColor: 'black'
      });
      
      const participantSignaturePad = new SignaturePad(participantCanvas, {
        backgroundColor: 'rgba(255, 255, 255, 0)',
        penColor: 'black'
      });

      // Draw placeholder text in signature pads
      function drawPlaceholder(canvas, text) {
        const ctx = canvas.getContext('2d');
        ctx.font = '16px Arial';
        ctx.fillStyle = '#aaa';
        ctx.textAlign = 'center';
        ctx.fillText(text, canvas.width / 2, canvas.height / 2);
        
        // Draw a line
        ctx.beginPath();
        ctx.moveTo(canvas.width * 0.3, canvas.height * 0.6);
        ctx.lineTo(canvas.width * 0.7, canvas.height * 0.6);
        ctx.stroke();
      }

      // Resize canvas to match parent width
      function resizeCanvas(canvas, signaturePad) {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        canvas.getContext('2d').scale(ratio, ratio);
        signaturePad.clear();
        drawPlaceholder(canvas, 'Sign Here');
      }

      // Initialize canvas sizes
      resizeCanvas(ownerCanvas, ownerSignaturePad);
      resizeCanvas(participantCanvas, participantSignaturePad);

      // Handle window resize
      window.addEventListener('resize', function() {
        resizeCanvas(ownerCanvas, ownerSignaturePad);
        resizeCanvas(participantCanvas, participantSignaturePad);
      });

      // Clear participant signature
      document.getElementById('clearParticipantSignature').addEventListener('click', function() {
        participantSignaturePad.clear();
        drawPlaceholder(participantCanvas, 'Sign Here');
      });

      // Handle number buttons for accessories
      const numberButtons = document.querySelectorAll('.number-button');
      numberButtons.forEach(button => {
        button.addEventListener('click', function() {
          const value = this.getAttribute('data-value');
          const type = this.getAttribute('data-type');
          
          // Update hidden input
          document.getElementById(`${type}Count`).value = value;
          
          // Update active state
          document.querySelectorAll(`.number-button[data-type="${type}"]`).forEach(btn => {
            btn.classList.remove('active');
          });
          this.classList.add('active');
        });
      });

      // File upload preview
      function handleFileUpload(inputElement, containerElement) {
        inputElement.addEventListener('change', function(e) {
          const files = e.target.files;
          if (files.length > 0) {
            const fileNames = Array.from(files).map(file => file.name).join(', ');
            const uploadText = containerElement.querySelector('.upload-text');
            uploadText.textContent = fileNames.length > 30 ? fileNames.substring(0, 30) + '...' : fileNames;
          }
        });

        // Handle drag and drop
        containerElement.addEventListener('dragover', function(e) {
          e.preventDefault();
          containerElement.style.borderColor = '#34d399';
        });

        containerElement.addEventListener('dragleave', function(e) {
          e.preventDefault();
          containerElement.style.borderColor = '#d1d5db';
        });

        containerElement.addEventListener('drop', function(e) {
          e.preventDefault();
          containerElement.style.borderColor = '#d1d5db';
          
          if (e.dataTransfer.files.length > 0) {
            inputElement.files = e.dataTransfer.files;
            const event = new Event('change');
            inputElement.dispatchEvent(event);
          }
        });
      }

      // Initialize file uploads
      handleFileUpload(
        document.getElementById('idFile'),
        document.getElementById('idUpload')
      );
      
      handleFileUpload(
        document.getElementById('conditionFiles'),
        document.getElementById('conditionUpload')
      );

      // Toast notification
      const toast = document.getElementById('toast');
      const toastTitle = document.getElementById('toastTitle');
      const toastMessage = document.getElementById('toastMessage');
      const toastClose = document.getElementById('toastClose');

      function showToast(title, message, type = 'success') {
        toastTitle.textContent = title;
        toastMessage.textContent = message;
        toast.className = `toast ${type} show`;
        
        setTimeout(() => {
          hideToast();
        }, 5000);
      }

      function hideToast() {
        toast.classList.remove('show');
      }

      toastClose.addEventListener('click', hideToast);

      // Generate PDF from form data
      function generatePDF(formData) {
        return new Promise((resolve) => {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
          
          // Add title
          doc.setFontSize(20);
          doc.text("VEHICLE RENTAL AGREEMENT", 105, 20, { align: 'center' });
          
          // Add form data
          doc.setFontSize(12);
          let y = 40;
          
          // Renter information
          doc.setFontSize(16);
          doc.text("Renter Information", 20, y);
          y += 10;
          doc.setFontSize(12);
          doc.text(`Phone: ${formData.phoneCountry || ""} ${formData.phoneNumber || ""}`, 20, y);
          y += 10;
          
          // Vehicle information
          doc.setFontSize(16);
          doc.text("Vehicle Information", 20, y);
          y += 10;
          doc.setFontSize(12);
          
          // Vehicle type
          const vehicleTypes = [];
          if (formData.escooter) vehicleTypes.push("E-Scooter");
          if (formData.mountainEbike) vehicleTypes.push("Mountain E-Bike");
          if (formData.trekkingEbike) vehicleTypes.push("Trekking E-bike");
          if (formData.fatTireEbike) vehicleTypes.push("Fat Tire E-bike");
          
          doc.text(`Vehicle Type: ${vehicleTypes.join(", ") || "None selected"}`, 20, y);
          y += 10;
          
          // Rental period
          doc.setFontSize(16);
          doc.text("Rental Period", 20, y);
          y += 10;
          doc.setFontSize(12);
          doc.text(`From: ${formData.fromDate || "Not specified"} at ${formData.fromTime || "Not specified"}`, 20, y);
          y += 6;
          doc.text(`Until: ${formData.untilDate || "Not specified"} at ${formData.untilTime || "Not specified"}`, 20, y);
          y += 10;
          
          // Accessories
          doc.setFontSize(16);
          doc.text("Accessories", 20, y);
          y += 10;
          doc.setFontSize(12);
          doc.text(`Helmet: ${formData.helmet || "0"}`, 20, y);
          y += 6;
          doc.text(`Lock: ${formData.lock || "0"}`, 20, y);
          y += 6;
          doc.text(`Elastic Straps: ${formData.elasticStraps || "0"}`, 20, y);
          y += 6;
          
          // Other accessories
          const otherAccessories = [];
          if (formData.bikeMirror) otherAccessories.push("Bike Mirror");
          if (formData.phoneMount) otherAccessories.push("Phone Mount");
          if (formData.charger) otherAccessories.push("Charger");
          if (formData.batteryKey) otherAccessories.push("Battery Key");
          if (formData.babySeat) otherAccessories.push("Baby Seat");
          if (formData.bikeBasket) otherAccessories.push("Bike Basket");
          if (formData.seatCushion) otherAccessories.push("Seat Cushion");
          
          doc.text(`Other Accessories: ${otherAccessories.join(", ") || "None selected"}`, 20, y);
          y += 10;
          
          // Underage participant
          doc.text(`Underage Participant: ${formData.isUnderage === "yes" ? "Yes" : "No"}`, 20, y);
          y += 10;
          
          // Terms and conditions
          doc.setFontSize(16);
          doc.text("Terms and Conditions", 20, y);
          y += 10;
          doc.setFontSize(10);
          doc.text("TERMS AND CONDITIONS OF VEHICLE RENTAL", 20, y);
          y += 6;
          
          const termsText = "- Only the persons mentioned in the agreement will be allowed to drive the vehicle. In case any vehicle is to be used by an underage person, specifically (15-17) years old for the e-bikes or (12-17) for the scooters, then this contract is the written consent of the parent.";
          const splitTerms = doc.splitTextToSize(termsText, 170);
          doc.text(splitTerms, 20, y);
          y += splitTerms.length * 5;
          
          doc.text("-The renter is responsible for any violation of traffic rules: wrong parking, fast driving etc.", 20, y);
          y += 6;
          
          const termsText2 = "- It is strictly forbidden to ride a bike/scooter off-road, to ride any bike/scooter on the beach and to ride any bike/scooter with more than one person.";
          const splitTerms2 = doc.splitTextToSize(termsText2, 170);
          doc.text(splitTerms2, 20, y);
          y += splitTerms2.length * 5;
          
          doc.text("- The renter is obliged to return the vehicle's batteries fully charged, if the rental period is at least 24 hours.", 20, y);
          y += 10;
          
          // Agreement
          doc.setFontSize(12);
          doc.text(`Terms Agreed: ${formData.termsAgreed ? "Yes" : "No"}`, 20, y);
          y += 10;
          
          // Signatures
          doc.setFontSize(16);
          doc.text("Signatures", 20, y);
          y += 10;
          doc.setFontSize(12);
          
          // Add signatures if available
          if (formData.ownerSignature) {
            doc.text("Owner Signature:", 20, y);
            y += 6;
            doc.addImage(formData.ownerSignature, 'PNG', 20, y, 50, 25);
            y += 30;
          }
          
          if (formData.participantSignature) {
            doc.text("Participant Signature:", 20, y);
            y += 6;
            doc.addImage(formData.participantSignature, 'PNG', 20, y, 50, 25);
            y += 30;
          }
          
          // Add date of submission
          doc.setFontSize(10);
          doc.text(`Form submitted on: ${new Date().toLocaleString()}`, 150, 280, { align: 'right' });
          
          resolve(doc);
        });
      }

      // Function to create a JWT token for Google API authentication
      function createJWT() {
        const now = Math.floor(Date.now() / 1000);
        const oneHour = 60 * 60;
        const expiry = now + oneHour;
        
        const payload = {
          iss: GOOGLE_SERVICE_ACCOUNT_EMAIL,
          scope: 'https://www.googleapis.com/auth/drive.file',
          aud: 'https://oauth2.googleapis.com/token',
          exp: expiry,
          iat: now
        };
        
        // Use jwt-encode library to create the JWT
        return window.jwtEncode(payload, GOOGLE_PRIVATE_KEY, { algorithm: 'RS256' });
      }

      // Function to get an access token from Google
      async function getGoogleAccessToken() {
        const jwt = createJWT();
        
        const response = await fetch('https://oauth2.googleapis.com/token', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: new URLSearchParams({
            grant_type: 'urn:ietf:params:oauth:grant-type:jwt-bearer',
            assertion: jwt
          })
        });
        
        const data = await response.json();
        return data.access_token;
      }

      // Function to upload PDF to Google Drive
      async function uploadPdfToGoogleDrive(pdfDoc, fileName) {
        try {
          // Get access token
          const accessToken = await getGoogleAccessToken();
          
          // Convert PDF to blob
          const pdfBlob = pdfDoc.output('blob');
          
          // Create file metadata
          const metadata = {
            name: fileName,
            mimeType: 'application/pdf',
            parents: [GOOGLE_DRIVE_FOLDER_ID]
          };
          
          // Create multipart request
          const form = new FormData();
          form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
          form.append('file', pdfBlob);
          
          // Upload to Google Drive
          const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${accessToken}`
            },
            body: form
          });
          
          const result = await response.json();
          return result.id;
        } catch (error) {
          console.error('Error uploading to Google Drive:', error);
          throw error;
        }
      }

      // Form submission
      const form = document.getElementById('vehicleRentalForm');
      const submitButton = document.getElementById('submitButton');

      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Validate required fields
        if (participantSignaturePad.isEmpty()) {
          showToast('Missing signature', 'Participant signature is required', 'error');
          return;
        }

        if (!document.getElementById('termsAgreed').checked) {
          showToast('Terms not accepted', 'You must agree to the terms and conditions', 'error');
          return;
        }

        // Disable submit button
        submitButton.disabled = true;
        submitButton.textContent = 'Submitting...';

        // Collect form data
        const formData = {
          // Basic information
          phoneCountry: document.getElementById('phoneCountry').value,
          phoneNumber: document.getElementById('phoneNumber').value,
          
          // Vehicle type
          escooter: document.getElementById('escooter').checked,
          mountainEbike: document.getElementById('mountainEbike').checked,
          trekkingEbike: document.getElementById('trekkingEbike').checked,
          fatTireEbike: document.getElementById('fatTireEbike').checked,
          
          // Accessories
          helmet: document.getElementById('helmetCount').value,
          lock: document.getElementById('lockCount').value,
          elasticStraps: document.getElementById('strapsCount').value,
          
          bikeMirror: document.getElementById('bikeMirror').checked,
          phoneMount: document.getElementById('phoneMount').checked,
          charger: document.getElementById('charger').checked,
          batteryKey: document.getElementById('batteryKey').checked,
          babySeat: document.getElementById('babySeat').checked,
          bikeBasket: document.getElementById('bikeBasket').checked,
          seatCushion: document.getElementById('seatCushion').checked,
          
          // Dates and times
          fromDate: document.getElementById('fromDate').value,
          fromTime: document.getElementById('fromTime').value,
          untilDate: document.getElementById('untilDate').value,
          untilTime: document.getElementById('untilTime').value,
          
          // Terms and underage
          termsAgreed: document.getElementById('termsAgreed').checked,
          isUnderage: document.querySelector('input[name="isUnderage"]:checked')?.value || null,
          
          // Signatures
          ownerSignature: !ownerSignaturePad.isEmpty() ? ownerSignaturePad.toDataURL() : null,
          participantSignature: !participantSignaturePad.isEmpty() ? participantSignaturePad.toDataURL() : null,
        };
        
        try {
          // Generate PDF
          const pdfDoc = await generatePDF(formData);
          const fileName = `Vehicle Rental - ${new Date().toISOString().split('T')[0]}.pdf`;
          
          // Upload to Google Drive
          const fileId = await uploadPdfToGoogleDrive(pdfDoc, fileName);
          
          showToast('Form submitted successfully', 'A PDF copy has been saved to Google Drive');
          
        } catch (error) {
          console.error('Error processing form:', error);
          showToast('Form submission failed', 'There was an error saving your form to Google Drive. Please try again.', 'error');
        } finally {
          // Re-enable submit button
          submitButton.disabled = false;
          submitButton.textContent = 'Submit';
        }
      });
    });
  </script>
</body>
</html>
